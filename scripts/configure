#!/usr/bin/env bash

# Configure script for 9ferno on NixOS
# This script sets up mkconfig for the local environment

set -e

echo "=== Configuring 9ferno for NixOS ==="

# Get the absolute path to the 9ferno root
ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
echo "ROOT: $ROOT"

# Backup original mkconfig
if [ ! -f "$ROOT/mkconfig.backup" ]; then
    cp "$ROOT/mkconfig" "$ROOT/mkconfig.backup"
    echo "Backed up original mkconfig to mkconfig.backup"
fi

# Determine architecture
HOST_ARCH=$(uname -m)
case "$HOST_ARCH" in
    x86_64)
        OBJTYPE="amd64"
        ;;
    i686|i586|i386)
        OBJTYPE="386"
        ;;
    aarch64)
        OBJTYPE="arm64"
        ;;
    arm*)
        OBJTYPE="arm"
        ;;
    *)
        echo "Warning: Unknown architecture $HOST_ARCH, defaulting to amd64"
        OBJTYPE="amd64"
        ;;
esac

echo "Host architecture: $HOST_ARCH"
echo "OBJTYPE: $OBJTYPE"

# Create new mkconfig
cat > "$ROOT/mkconfig" << EOF
#
#	9ferno configuration for NixOS
#	Auto-generated by scripts/configure
#

ROOT=$ROOT

#
#	Specify the flavour of Tk (std for standard builds)
#
TKSTYLE=std

# emu target, emu-g is a headless variant. Linux/BSD only (emu, emu-g)
CONF=emu

#	binary will be placed at \$SYSTARG/\$OBJTYPE/bin/\$CONF

#
#	Except for building kernels, SYSTARG must always be the same as SYSHOST
#
SYSHOST=Linux		# build system OS type
SYSTARG=\$SYSHOST	# target system OS type

#
#	specify the architecture of the target system
#
OBJTYPE=$OBJTYPE

#
#	no changes required beyond this point
#
OBJDIR=\$SYSTARG/\$OBJTYPE

<\$ROOT/mkfiles/mkhost-\$SYSHOST			# variables appropriate for host system
<\$ROOT/mkfiles/mkfile-\$SYSTARG-\$OBJTYPE	# variables used to build target object type
EOF

echo "Created mkconfig with:"
echo "  ROOT=$ROOT"
echo "  SYSHOST=Linux"
echo "  OBJTYPE=$OBJTYPE"
echo "  CONF=emu"

echo ""
echo "=== Configuration complete ==="
echo "Next step: Run ./scripts/build"

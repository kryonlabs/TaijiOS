# krbview - KRB File Viewer with Native RC Execution

A native application for viewing and interacting with Kryon Binary (KRB) files. Supports full RC script execution and widget inspection.

## Features

- **Native KRB Rendering** - Renders any KRB content using the existing libkrb_render.a
- **RC Script Execution** - Executes embedded RC scripts via the RC shell integration
- **Interactive Widgets** - Full support for buttons, inputs, text, and other widgets
- **Event Handling** - Mouse and keyboard event processing
- **Status Bar** - Displays RC script output

## Building

```sh
cd /mnt/storage/Projects/TaijiOS
mk install
```

This will build krbview along with other utilities.

## Usage

```sh
# Basic usage
krbview file.krb

# With custom window size
krbview -W 1280 -H 720 file.krb

# Debug mode
krbview -debug file.krb

# Enable RC debug output
krbview -rc-debug file.krb
```

## Command-Line Options

- `-W <width>` - Window width (default: 1024)
- `-H <height>` - Window height (default: 768)
- `-debug` - Enable debug mode
- `-inspector` - Show inspector panel (TODO in Phase 4)
- `-rc-debug` - Enable RC debug output
- `-h` - Show help message

## Architecture

```
krbview Application
├── Main Viewer Window
│   ├── Toolbar (File controls, View modes) - TODO
│   ├── Split Pane
│   │   ├── Left: Rendered KRB Content
│   │   └── Right: Inspector/Debugger - TODO in Phase 4
│   └── Status Bar (Event log, RC output)
```

## Component Files

### Core Application
- `krbview.c` - Main entry point and event loop
- `krbview.h` - Application state structures

### Component Wrappers
- `krbview_loader.c/h` - KRB file loading wrapper
- `krbview_renderer.c/h` - Rendering wrapper
- `krbview_events.c/h` - Event handling
- `krbview_rc.c/h` - RC shell integration

## Implementation Status

### Phase 1: Foundation (COMPLETE ✅)
- [x] Project structure and mkfiles
- [x] KRB file loading wrapper
- [x] Rendering wrapper
- [x] Main window and event loop
- [x] Basic widget tree rendering

### Phase 2: Interactivity (COMPLETE ✅)
- [x] Event handling system
- [x] Mouse click/hover detection
- [x] Keyboard input handling
- [x] Focus management
- [x] Widget state updates

### Phase 3: RC Shell Integration (COMPLETE ✅)
- [x] RC shell VM integration
- [x] RC execution bridge
- [x] Variable synchronization (widget ↔ RC)
- [x] Event data passing to RC scripts
- [x] RC output capture and display

### Phase 4: Inspector/Debugger (TODO)
- [ ] Widget tree view
- [ ] Property grid
- [ ] Script viewer
- [ ] Event log
- [ ] Live property editing

### Phase 5: Polish (TODO)
- [ ] Error handling and recovery
- [ ] Performance optimization (dirty regions)
- [ ] File reload functionality
- [ ] Documentation

## Example KRB Files

### Simple Counter

```kry
// counter.kry
Container {
    backgroundColor = "#191970FF"
    padding = 20px

    Column {
        Text {
            id = "count_label"
            text = "Count: 0"
            color = "white"
            fontSize = 24
        }

        Button {
            id = "increment"
            text = "Increment"
            onClick: rc {
                count = ${count:-0}
                count = $count + 1
                set_widget_prop count_label text "Count: $count"
            }
        }
    }
}
```

Compile and run:
```sh
kryon compile counter.kry -o counter.krb
krbview counter.krb
```

## Dependencies

- `libkrb.a` - KRB file parsing
- `libkrb_runtime.a` - Widget management and runtime
- `libkrb_render.a` - Rendering engine
- `libkrb_shell.a` - RC shell integration
- `libdraw.a` - Drawing primitives
- `libmemdraw.a` - Memory drawing

## RC Script Integration

krbview executes RC scripts embedded in KRB files. Scripts have access to:

### Automatic Variables

- `$widget_id` - ID of the widget that triggered the event
- `$widget_type` - Type of the widget
- `$event_type` - Type of event ("click", "change", etc.)
- `$mouse_x`, `$mouse_y` - Mouse position
- `$key` - Keyboard input

### Built-in Functions

- `get_widget_prop <widget_id> <property>` - Get widget property
- `set_widget_prop <widget_id> <property> <value>` - Set widget property
- `echo <args...>` - Print to status bar

## Future Work

1. **Native RC Shell** - Replace Inferno sh.dis with native RC from `/home/wao/Projects/TaijiOS/utils/rcsh/`
2. **Inspector Panel** - Interactive widget inspector
3. **Debugging** - Breakpoints, step-through, variable inspection
4. **Hot Reload** - Reload KRB files without restarting
5. **Performance** - Dirty region rendering, incremental updates

## License

Part of the TaijiOS project.
